@{
    ViewData["Title"] = "MarketSpace - SSE Demo";
}

@section Styles {
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
    <style>
        .demo-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .demo-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .operation-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: none;
        }

        .operation-card.active {
            display: block;
        }

        .progress-container {
            margin: 1rem 0;
        }

        .progress {
            height: 25px;
            background-color: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            width: 0%;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-started { background-color: #17a2b8; color: white; }
        .status-processing { background-color: #ffc107; color: #212529; }
        .status-completed { background-color: #28a745; color: white; }
        .status-failed { background-color: #dc3545; color: white; }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s ease forwards;
        }


        .product-card.out-of-stock {
            opacity: 0.6;
            background-color: #f8f9fa;
        }

        .btn-demo {
            margin: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background-color: #667eea; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-demo:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .log-console {
            background: #1e1e1e;
            color: #0dbc79;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
}

<div class="demo-container">
    <h1>🛍️ MarketSpace SSE Demo</h1>
    <p class="lead">Real-time catalog operations using Server-Sent Events</p>

    <!-- Control Panel -->
    <div class="demo-section">
        <h3>📡 Operation Controls</h3>
        <p>Start different types of catalog operations and watch real-time progress via SSE:</p>
        
        <button class="btn-demo btn-primary" onclick="startCatalogDemo()">
            📦 Load Full Catalog
        </button>
        <button class="btn-demo btn-success" onclick="startSearchDemo()">
            🔍 Search Products
        </button>
        <button class="btn-demo btn-warning" onclick="startFilterDemo()">
            🎯 Apply Filters
        </button>
        
        <button class="btn-demo" onclick="clearResults()" style="background: #6c757d; color: white;">
            🗑️ Clear Results
        </button>
    </div>

    <!-- Operation Status -->
    <div class="demo-section">
        <h3>📊 Operation Status</h3>
        
        <div id="operation-status" class="operation-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h5 id="operation-title">Catalog Operation</h5>
                <span id="status-badge" class="status-badge status-started">Started</span>
            </div>
            
            <div class="progress-container">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar">0%</div>
                </div>
            </div>
            
            <p id="status-message" class="message-text">Initializing...</p>
            <small id="operation-timing" class="text-muted">Started: <span id="start-time">--</span> | Duration: <span id="duration">--</span></small>
        </div>
    </div>

    <!-- Results Display -->
    <div class="demo-section">
        <h3>🎯 Results</h3>
        <div id="results-summary" style="display: none;">
            <p><strong>Total Items:</strong> <span id="total-count">0</span></p>
            <p><strong>Load Time:</strong> <span id="load-time">--</span></p>
        </div>
        
        <div id="catalog-results" class="catalog-grid"></div>
    </div>

    <!-- SSE Console Log -->
    <div class="demo-section">
        <h3>🔧 SSE Console</h3>
        <div id="sse-console" class="log-console">SSE Demo initialized. Click a button above to start an operation...\n</div>
        <button class="btn-demo" onclick="clearConsole()" style="background: #6c757d; color: white; margin-top: 0.5rem;">
            Clear Console
        </button>
    </div>
</div>

@section Scripts {
    <script src="~/js/generic-sse-client.js" asp-append-version="true"></script>
    <script src="~/js/home/home.js" asp-append-version="true"></script>
    <script>
        let currentOperationId = null;
        let operationStartTime = null;

        function logToConsole(message) {
            const console = document.getElementById('sse-console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('sse-console').textContent = 'Console cleared.\n';
        }

        function clearResults() {
            document.getElementById('catalog-results').innerHTML = '';
            document.getElementById('results-summary').style.display = 'none';
            document.getElementById('operation-status').classList.remove('active');
            if (currentOperationId) {
                window.HomeModule.stopMonitoring(currentOperationId);
                currentOperationId = null;
            }
            logToConsole('Results cleared and operation stopped.');
        }

        async function startCatalogDemo() {
            try {
                logToConsole('🚀 Starting catalog operation...');
                showOperationCard('Full Catalog Load');
                
                const response = await window.HomeModule.loadCatalog({ 
                    page: 1, 
                    pageSize: 50,
                    includeOutOfStock: true 
                });
                
                currentOperationId = response.operationId;
                logToConsole(`📡 SSE connection established for operation: ${response.operationId}`);
            } catch (error) {
                logToConsole(`❌ Error starting catalog operation: ${error.message}`);
            }
        }

        async function startSearchDemo() {
            try {
                logToConsole('🔍 Starting search operation...');
                showOperationCard('Product Search');
                
                const response = await window.HomeModule.searchProducts('electronics', { 
                    sortBy: 'relevance',
                    maxResults: 15
                });
                
                currentOperationId = response.operationId;
                logToConsole(`📡 SSE connection established for search: ${response.operationId}`);
            } catch (error) {
                logToConsole(`❌ Error starting search operation: ${error.message}`);
            }
        }

        async function startFilterDemo() {
            try {
                logToConsole('🎯 Starting filter operation...');
                showOperationCard('Apply Filters');
                
                const response = await window.HomeModule.filterProducts({ 
                    category: 'Electronics',
                    priceRange: { min: 20, max: 200 },
                    inStockOnly: true
                });
                
                currentOperationId = response.operationId;
                logToConsole(`📡 SSE connection established for filtering: ${response.operationId}`);
            } catch (error) {
                logToConsole(`❌ Error starting filter operation: ${error.message}`);
            }
        }

        function showOperationCard(title) {
            const card = document.getElementById('operation-status');
            const titleEl = document.getElementById('operation-title');
            const startTimeEl = document.getElementById('start-time');
            
            titleEl.textContent = title;
            startTimeEl.textContent = new Date().toLocaleTimeString();
            operationStartTime = Date.now();
            
            card.classList.add('active');
            card.setAttribute('data-operation-id', 'pending');
            
            // Reset progress
            updateProgress(0, 'Started', 'Initializing...');
        }

        function updateProgress(progress, status, message) {
            const progressBar = document.getElementById('progress-bar');
            const statusBadge = document.getElementById('status-badge');
            const messageEl = document.getElementById('status-message');
            const durationEl = document.getElementById('duration');
            
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            
            statusBadge.textContent = status;
            statusBadge.className = `status-badge status-${status.toLowerCase()}`;
            
            messageEl.textContent = message;
            
            if (operationStartTime) {
                const duration = Math.round((Date.now() - operationStartTime) / 1000);
                durationEl.textContent = `${duration}s`;
            }
        }

        function displayResults(operationData) {
            const resultsContainer = document.getElementById('catalog-results');
            const summaryContainer = document.getElementById('results-summary');
            const totalCountEl = document.getElementById('total-count');
            const loadTimeEl = document.getElementById('load-time');
            
            if (operationData.Result && operationData.Result.Items) {
                const items = operationData.Result.Items;
                
                // Show summary
                totalCountEl.textContent = items.length;
                loadTimeEl.textContent = operationData.Result.LoadTime ? 
                    new Date(operationData.Result.LoadTime).toLocaleTimeString() : 
                    'Just now';
                summaryContainer.style.display = 'block';
                
                // Clear and populate results
                resultsContainer.innerHTML = '';
                
                items.forEach((item, index) => {
                    setTimeout(() => {
                        const productCard = document.createElement('div');
                        productCard.className = `product-card ${!item.InStock ? 'out-of-stock' : ''}`;
                        productCard.innerHTML = `
                            <h6>${item.Name}</h6>
                            <p class="price">$${item.Price}</p>
                            <p class="category">${item.Category}</p>
                            <p class="stock-status">${item.InStock ? '✅ In Stock' : '❌ Out of Stock'}</p>
                        `;
                        resultsContainer.appendChild(productCard);
                    }, index * 50);
                });
                
                logToConsole(`📦 Displayed ${items.length} items in catalog`);
            }
        }

        // Listen for SSE events
        document.addEventListener('catalogStatusUpdate', (event) => {
            const { operationId, data } = event.detail;
            
            logToConsole(`📊 Progress: ${data.Progress}% - ${data.Message}`);
            updateProgress(data.Progress, data.Status, data.Message);
            
            // Update operation card data attribute
            document.getElementById('operation-status').setAttribute('data-operation-id', operationId);
        });

        document.addEventListener('catalogComplete', (event) => {
            const { operationId, data } = event.detail;
            
            logToConsole(`✅ Operation ${operationId} completed successfully!`);
            updateProgress(100, 'Completed', 'Operation completed successfully');
            
            // Display results
            displayResults(data);
            
            currentOperationId = null;
        });

        document.addEventListener('catalogError', (event) => {
            const { operationId, error } = event.detail;
            
            logToConsole(`❌ Operation ${operationId} failed: ${error}`);
            updateProgress(100, 'Failed', `Error: ${error}`);
            
            currentOperationId = null;
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('🎉 Generic SSE Catalog Demo ready!');
            logToConsole('💡 Using new generic SSE client architecture');
        });
    </script>
}
