@{
    ViewData["Title"] = "Scroll Infinito - Exemplo";
}

<div class="container mt-4">
    <h2>Lista de Produtos com Scroll Infinito</h2>
    <p class="text-muted">Este exemplo demonstra as melhores práticas para scroll infinito em ASP.NET Core</p>
    
    <!-- Container para os produtos -->
    <div id="products-container" class="row">
        <!-- Os produtos serão carregados aqui dinamicamente -->
    </div>
    
    <!-- Indicador de carregamento -->
    <div id="loading-indicator" class="text-center my-4" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2">Carregando mais produtos...</p>
    </div>
    
    <!-- Mensagem quando não há mais produtos -->
    <div id="no-more-products" class="text-center my-4" style="display: none;">
        <p class="text-muted">Não há mais produtos para carregar.</p>
    </div>
</div>

<script>
// Implementação do scroll infinito com as melhores práticas
class InfiniteScrollManager {
    constructor() {
        this.currentPage = 1;
        this.pageSize = 20;
        this.isLoading = false;
        this.hasMoreProducts = true;
        this.abortController = null;
        
        this.container = document.getElementById('products-container');
        this.loadingIndicator = document.getElementById('loading-indicator');
        this.noMoreProducts = document.getElementById('no-more-products');
        
        this.init();
    }
    
    init() {
        // Carrega a primeira página
        this.loadProducts();
        
        // Configura o listener para scroll infinito
        this.setupScrollListener();
    }
    
    setupScrollListener() {
        let scrollTimeout;
        
        // Usa throttling para otimizar performance
        window.addEventListener('scroll', () => {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            
            scrollTimeout = setTimeout(() => {
                this.handleScroll();
            }, 100); // Debounce de 100ms
        });
    }
    
    handleScroll() {
        // Verifica se está próximo do final da página
        const threshold = 200; // pixels antes do final
        const scrollPosition = window.innerHeight + window.scrollY;
        const documentHeight = document.documentElement.offsetHeight;
        
        if (scrollPosition >= documentHeight - threshold) {
            this.loadProducts();
        }
    }
    
    async loadProducts() {
        // Previne múltiplas requisições simultâneas
        if (this.isLoading || !this.hasMoreProducts) {
            return;
        }
        
        this.isLoading = true;
        this.showLoading();
        
        try {
            // Cancela requisição anterior se ainda estiver pendente
            if (this.abortController) {
                this.abortController.abort();
            }
            
            // Cria novo AbortController para cancelamento
            this.abortController = new AbortController();
            
            const response = await fetch(
                `/api/products?page=${this.currentPage}&pageSize=${this.pageSize}`,
                {
                    signal: this.abortController.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                }
            );
            
            if (response.status === 204) {
                // Não há mais produtos
                this.hasMoreProducts = false;
                this.showNoMoreProducts();
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.products && data.products.length > 0) {
                this.renderProducts(data.products);
                this.currentPage++;
                
                // Verifica se há mais produtos baseado no total
                if (this.currentPage * this.pageSize >= data.count) {
                    this.hasMoreProducts = false;
                    this.showNoMoreProducts();
                }
            } else {
                this.hasMoreProducts = false;
                this.showNoMoreProducts();
            }
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Request was aborted');
                return;
            }
            
            console.error('Error loading products:', error);
            this.showError();
        } finally {
            this.isLoading = false;
            this.hideLoading();
        }
    }
    
    renderProducts(products) {
        // Renderiza os produtos de forma eficiente
        const fragment = document.createDocumentFragment();
        
        products.forEach(product => {
            const productElement = this.createProductElement(product);
            fragment.appendChild(productElement);
        });
        
        this.container.appendChild(fragment);
    }
    
    createProductElement(product) {
        const col = document.createElement('div');
        col.className = 'col-md-4 col-sm-6 mb-4';
        
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">${this.escapeHtml(product.name || 'Produto')}</h5>
                    <p class="card-text">${this.escapeHtml(product.description || 'Descrição não disponível')}</p>
                    <p class="card-text">
                        <strong>Preço: R$ ${(product.price || 0).toFixed(2)}</strong>
                    </p>
                </div>
            </div>
        `;
        
        return col;
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    showLoading() {
        this.loadingIndicator.style.display = 'block';
    }
    
    hideLoading() {
        this.loadingIndicator.style.display = 'none';
    }
    
    showNoMoreProducts() {
        this.noMoreProducts.style.display = 'block';
    }
    
    showError() {
        // Em caso de erro, mostra uma mensagem simples
        const errorElement = document.createElement('div');
        errorElement.className = 'alert alert-danger text-center';
        errorElement.textContent = 'Erro ao carregar produtos. Tente recarregar a página.';
        this.container.appendChild(errorElement);
    }
}

// Inicializa o scroll infinito quando a página carrega
document.addEventListener('DOMContentLoaded', () => {
    new InfiniteScrollManager();
});
</script>
